<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>INTP Today - ë§ˆêµ¬ ì§€ê»„ì´ê¸°</title>
<style>
body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 40px; overflow-y: auto; }
h1 { font-weight: 600; font-size: 26px; margin-bottom: 20px; }
.nickname { font-size: 14px; color: #888; margin-bottom: 20px; }
.container { max-width: 800px; margin: auto; }
textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; resize: none; background: #fafafa; }
button { padding: 8px 14px; margin-top: 10px; cursor: pointer; background: black; color: white; border-radius: 4px; border: none; }
.post { border: 1px solid #eee; padding: 18px; border-radius: 6px; margin-top: 20px; background: #fafafa; position: relative; box-sizing: border-box; width: 100%; }
.post .info { font-size: 13px; color: #777; margin-bottom: 8px; }
.actions { font-size: 13px; margin-top: 8px; }
.actions span { cursor: pointer; margin-right: 14px; }
.post-content.collapsed { max-height: 100px; overflow: hidden; }
.comment-section { display: flex; flex-direction: column; margin-top: 12px; border-top: 1px solid #eee; background:#f9f9f9; padding:5px; position: relative; }
.comment-list { overflow-y: auto; max-height: 400px; }
.comment { font-size: 14px; padding: 6px 0; margin-left: 10px; word-break: break-word; position: relative; }
.comment-actions { font-size: 12px; margin-left: 10px; cursor: pointer; color: #555; }
.comment-delete { position: absolute; right: 10px; font-size: 12px; color: red; cursor: pointer; }
.comment-input-area { display: flex; flex-direction: column; margin-top: 6px; }
.comment-input-area textarea { height: 60px; resize: none; }
.toggle-content-btn, .delete-post-btn { position: absolute; top: 10px; font-size: 12px; cursor: pointer; color: #555; background: none; border: none; }
.toggle-content-btn { right: 90px; }
.delete-post-btn { right: 170px; }
.sort-buttons { margin-bottom: 20px; }
.sort-buttons button { margin-right: 10px; background: #333; color:white; }
#postList { width: 100%; }
</style>
</head>
<body>
<div class="container">
<h1>INTP today</h1>
<h3>ì˜¤ëŠ˜ì˜ í•œë§ˆë”” : ëª¨ë‘ê°€ ë˜‘ê°™ì€ ê²ƒì„ ì›í•˜ëŠ” ì‚¬íšŒëŠ” ë¹„ì •ìƒì´ë‹¤.</h3>
<div class="nickname" id="nicknameDisplay"></div>

<textarea id="postInput" placeholder="ì•„ë¬´ ë§ì´ë‚˜ ì§€ê»„ì´ê¸°"></textarea>
<button onclick="submitPost()">ê²Œì‹œ</button>

<div class="sort-buttons">
    <button id="sortRecent" onclick="toggleSort('recent')">ì •ë ¬: ìµœê·¼ìˆœ</button>
    <button id="sortAgree" onclick="toggleSort('agree')">ì •ë ¬: ë”°ë´‰ìˆœ â–¼</button>
    <button id="sortComments" onclick="toggleSort('comments')">ì •ë ¬: ëŒ“ê¸€ë§ì€ìˆœ â–¼</button>
</div>

<div id="postList"></div>
</div>

<script>
const MAX_COMMENT_HEIGHT = 400;Â 
let posts = [];
let currentSort = 'recent';Â 
let sortOrder = { recent: 'desc', agree: 'desc', comments: 'desc' };

// ğŸ’¡ ê´€ë¦¬ì ê¶Œí•œì„ LocalStorage í”Œë˜ê·¸ë¡œ ì„¤ì •
const isAdmin = localStorage.getItem("isAdminMode") === "true";

// ğŸ’¡ 1. ì˜êµ¬ ì €ì¥ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
function savePosts() {
    localStorage.setItem('intp_posts', JSON.stringify(posts));
}
function loadPosts() {
    const storedPosts = localStorage.getItem('intp_posts');
    if (storedPosts) {
        posts = JSON.parse(storedPosts);
    }
}
loadPosts(); // ğŸ’¡ 2. í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸°

// --- ì ‘ê·¼ ì œì–´ ë° ìë™ ê²Œì‹œ ë¡œì§ ---

// 1. ì ‘ê·¼ ì œì–´: ë‹‰ë„¤ì„ì´ ì—†ìœ¼ë©´ ê²€ì¦ í˜ì´ì§€ë¡œ ëŒë ¤ë³´ëƒ„
function checkAccess(){
    const storedNickname = localStorage.getItem("nickname");
    
    if (!storedNickname || storedNickname.trim() === "") {
        alert("INTP todayì— ì ‘ì†í•˜ì‹œê¸° ì „ì— ë¶€íƒì´ ìˆì–´ìš”...");
        window.location.href = "index.html";
    }
}

// 2. ê²€ì¦ ë‹µë³€ì„ ê²Œì‹œë¬¼ë¡œ ìë™ ë“±ë¡í•˜ê³  ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
function autoPostVerificationAnswer() {
    const newPostContent = localStorage.getItem("newPostContent");
    const nickname = localStorage.getItem("nickname");

    if (newPostContent && nickname) {
        // ìƒˆë¡œìš´ ê²Œì‹œë¬¼ ìƒì„±
        const newPost = {
            id: 'post_' + Date.now() + '_' + Math.floor(Math.random() * 1000),
            content: newPostContent,Â 
            nickname: nickname,
            timestamp: Date.now(),
            agree: 0,
            comments: []
        };

        posts.unshift(newPost);
        
        localStorage.removeItem("newPostContent");Â 

        renderPosts();
        savePosts(); // ğŸ’¡ ìë™ ê²Œì‹œ í›„ ì˜êµ¬ ì €ì¥
    }
}

checkAccess();Â 
autoPostVerificationAnswer();Â 

// --- ğŸ’¡ ë‚˜ë¨¸ì§€ ë¡œì§ (ë°ì´í„° ë³€ê²½ ì‹œ savePosts() ì¶”ê°€) ---

function updateSortButtonText() {
    document.getElementById('sortRecent').innerText = 'ì •ë ¬: ' + (sortOrder.recent === 'desc' ? 'ìµœê·¼ìˆœ' : 'ìµœì´ˆìˆœ');
    document.getElementById('sortAgree').innerText = 'ì •ë ¬: ë”°ë´‰ìˆœ ' + (sortOrder.agree === 'desc' ? 'â–¼' : 'â–²');
    document.getElementById('sortComments').innerText = 'ì •ë ¬: ëŒ“ê¸€ë§ì€ìˆœ ' + (sortOrder.comments === 'desc' ? 'â–¼' : 'â–²');
    
    document.querySelectorAll('.sort-buttons button').forEach(btn => {
        // ê´€ë¦¬ì ëª¨ë“œì¼ ê²½ìš° ìƒ‰ìƒì„ ë‹¤ë¥´ê²Œ í‘œì‹œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        btn.style.backgroundColor = btn.id.includes(currentSort.charAt(0).toUpperCase() + currentSort.slice(1)) ? '#007bff' : '#333';
    });
}

function initializeNickname(){
    let name = localStorage.getItem("nickname");
    if(!name){
        let number = Math.floor(Math.random()*9000)+1000;
        name = "INTP #"+number;
        localStorage.setItem("nickname", name);
    }
    document.getElementById("nicknameDisplay").innerText = "ë‹¹ì‹ ì˜ ë‹‰ë„¤ì„: "+name + (isAdmin ? " (ê´€ë¦¬ì ëª¨ë“œ)" : ""); // ê´€ë¦¬ì í‘œì‹œ ì¶”ê°€
    updateSortButtonText();
}
initializeNickname();

function generateId(){ return 'post_'+Date.now()+'_'+Math.floor(Math.random()*1000); }

function sanitizeHTML(input){
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = input;
    const allowedTags=['B','STRONG','I','EM','U','BR','BLOCKQUOTE','SPAN'];
    const elements=tempDiv.getElementsByTagName('*');
    for(let i=elements.length-1;i>=0;i--){
        const el=elements[i];
        if(!allowedTags.includes(el.tagName)){
            el.replaceWith(document.createTextNode(el.innerText));
        } else if(el.tagName==='SPAN'){
            const color = el.style.color;
            const isValidColor = /^([a-zA-Z]+|#[0-9A-Fa-f]{3,6})$/.test(color);
            el.style = isValidColor ? `color:${color}` : '';
        }
    }
    return tempDiv.innerHTML;
}

function toggleSort(sortType){
    if(currentSort === sortType) {
        sortOrder[sortType] = sortOrder[sortType] === 'desc' ? 'asc' : 'desc';
    } else {
        currentSort = sortType;
    }
    updateSortButtonText();
    renderPosts();
}

function submitPost(){
    const input=document.getElementById('postInput');
    if(!input.value.trim()) return;
    const sanitizedContent=sanitizeHTML(input.value);
    posts.unshift({id:generateId(),content:sanitizedContent,nickname:localStorage.getItem('nickname'),timestamp:Date.now(),agree:0,comments:[]});
    input.value='';
    renderPosts();
    savePosts(); // ğŸ’¡ ì €ì¥ ì¶”ê°€
}

function toggleContent(postId){
    const content=document.getElementById('content'+postId);
    const btn=document.getElementById('toggleBtn'+postId);
    content.classList.toggle('collapsed');
    btn.innerText = content.classList.contains('collapsed') ? 'ë‚´ìš© í¼ì¹˜ê¸° â–¼':'ë‚´ìš© ì ‘ê¸° â–²';
}

function deletePost(postId){
    posts = posts.filter(p=>p.id!==postId);
    renderPosts();Â 
    savePosts(); // ğŸ’¡ ì €ì¥ ì¶”ê°€
}

function submitComment(postId){
    const input=document.getElementById('commentInput'+postId);
    if(!input.value.trim()) return;
    const sanitizedComment=sanitizeHTML(input.value);
    const post = posts.find(p=>p.id===postId);
    if(post){
        post.comments.push({nickname:localStorage.getItem('nickname'),content:sanitizedComment,agree:0});
        updateCommentCount(postId);
        savePosts(); // ğŸ’¡ ì €ì¥ ì¶”ê°€
    }
    input.value='';
    renderComments(postId,true);
}

function agreePost(event,postId){Â 
    event.stopPropagation();Â 
    const post=posts.find(p=>p.id===postId);Â 
    if(post){Â 
        post.agree++;Â 
        renderPosts();
        savePosts(); // ğŸ’¡ ì €ì¥ ì¶”ê°€
    }Â 
}

function agreeComment(event,postId,index){Â 
    event.stopPropagation();Â 
    const post=posts.find(p=>p.id===postId);Â 
    if(post && post.comments[index]){
        post.comments[index].agree++;Â 
        renderComments(postId,false);Â 
        savePosts(); // ğŸ’¡ ì €ì¥ ì¶”ê°€
    }Â 
}

function deleteComment(event,postId,index){Â 
    event.stopPropagation();Â 
    const post=posts.find(p=>p.id===postId);Â 
    if(post && post.comments[index]){Â 
        post.comments.splice(index,1);Â 
        renderComments(postId,false);Â 
        updateCommentCount(postId);
        renderPosts();Â 
        savePosts(); // ğŸ’¡ ì €ì¥ ì¶”ê°€
    }Â 
}

function toggleComment(postId){
    const section = document.getElementById('c'+postId);
    section.style.display = section.style.display==='flex'?'none':'flex';
    if(section.style.display==='flex') scrollCommentBottom(postId);
}

function scrollCommentBottom(postId){
    const listDiv = document.querySelector('#c'+postId+' .comment-list');
    if(listDiv){
        listDiv.scrollTop = listDiv.scrollHeight;
        listDiv.style.maxHeight = MAX_COMMENT_HEIGHT+'px';
        listDiv.style.overflowY = (listDiv.scrollHeight>MAX_COMMENT_HEIGHT)?'auto':'visible';
    }
}

function updateCommentCount(postId){
    const post = posts.find(p=>p.id===postId);
    if(!post) return;
    const commentBtn = document.querySelector('#post_'+postId+' .actions span.comment-btn');
    if(commentBtn) commentBtn.innerText = `ğŸ’¬ ëŒ“ê¸€ ${post.comments.length}ê°œ`;
}

// ëŒ“ê¸€ì°½ ìƒíƒœ ì €ì¥/ë³µì› ë¡œì§ í¬í•¨ëœ renderPosts í•¨ìˆ˜
function renderPosts(){
    const postListDiv=document.getElementById('postList');
    if(posts.length===0) {
        postListDiv.innerHTML = '<p style="text-align:center; color:#777; margin-top:30px;">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì•„ë¬´ë§ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
        return;
    }
    
    const openCommentIds = Array.from(document.querySelectorAll('.comment-section')).filter(c => c.style.display === 'flex').map(c => c.id);

    let sortedPosts = [...posts];
    const orderMultiplier = sortOrder[currentSort] === 'asc' ? 1 : -1;

    if(currentSort === 'recent') {
        sortedPosts.sort((a,b) => (a.timestamp - b.timestamp) * orderMultiplier);
    }
    else if(currentSort === 'agree') {
        sortedPosts.sort((a,b) => {
            if(a.agree !== b.agree) {
                return (a.agree - b.agree) * orderMultiplier;
            }
            return b.timestamp - a.timestamp;Â 
        });
    }
    else if(currentSort === 'comments') {
        sortedPosts.sort((a,b) => {
            if(a.comments.length !== b.comments.length) {
                return (a.comments.length - b.comments.length) * orderMultiplier;
            }
            return b.timestamp - a.timestamp;
        });
    }
    
    postListDiv.innerHTML = '';Â 

    sortedPosts.forEach(post=>{
        const postDiv=document.createElement('div');
        postDiv.className='post';
        postDiv.id='post_'+post.id;

        const isLong=post.content.length>300;
        const contentClass=isLong?'post-content collapsed':'post-content';

        postDiv.innerHTML=`
            <div class='info'>${post.nickname} Â· ${new Date(post.timestamp).toLocaleString()}</div>
            <div id='content${post.id}' class='${contentClass}'>${post.content}</div>
            ${isLong?`<button class='toggle-content-btn' id='toggleBtn${post.id}' onclick='toggleContent("${post.id}")'>ë‚´ìš© í¼ì¹˜ê¸° â–¼</button>`:''}
            ${isAdmin?`<button class='delete-post-btn' onclick='deletePost("${post.id}")'>ì‚­ì œ ğŸ—‘ï¸</button>`:''}
            <div class='actions'>
                <span onclick='agreePost(event,"${post.id}")'>ğŸ‘ ë™ì˜ (<span id="agreeCount_${post.id}">${post.agree}</span>)</span>
                <span class='comment-btn' onclick='toggleComment("${post.id}")'>ğŸ’¬ ëŒ“ê¸€ ${post.comments.length}ê°œ</span>
            </div>
            <div class='comment-section' id='c${post.id}' style='display:none;'>
                <div class='comment-list'></div>
                <div class='comment-input-area'>
                    <textarea id='commentInput${post.id}' placeholder='ëŒ“ê¸€ ì…ë ¥'></textarea>
                    <button onclick='submitComment("${post.id}")'>ì‘ì„±</button>
                </div>
            </div>
        `;

        postListDiv.appendChild(postDiv);
        renderComments(post.id,false);
    });

    openCommentIds.forEach(id => {
        const section = document.getElementById(id);
        if (section) {
            section.style.display = 'flex';
            scrollCommentBottom(section.id.substring(1));
        }
    });
}

function renderComments(postId,scroll=true){
    const post = posts.find(p=>p.id===postId);
    if(!post) return;
    const section = document.getElementById('c'+postId);
    if(!section) return;
    const listDiv = section.querySelector('.comment-list');
    listDiv.innerHTML = post.comments.map((c,index)=>{
        const isAuthor = c.nickname === localStorage.getItem('nickname');
        return `<div class='comment'>- ${c.nickname}: ${c.content}Â 
            <span class='comment-actions' onclick='agreeComment(event,"${postId}",${index})'>ğŸ‘ ${c.agree}</span>
            ${isAuthor || isAdmin ? `<span class='comment-delete' onclick='deleteComment(event,"${postId}",${index})'>ì‚­ì œ</span>` : ''} </div>`;
    }).join('');
    scroll && scrollCommentBottom(postId);
}

// ğŸ’¡ DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (autoPostVerificationAnswer()ì—ì„œ renderPosts()ë¥¼ ì´ë¯¸ í˜¸ì¶œí•¨)
</script>
</body>
</html>
